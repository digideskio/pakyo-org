require 'rake'
require 'rake/testtask'
require 'pakyow-rake'

env = ARGV[1] || 'development'
env = env.split('=')[1] || env

namespace :db do
  desc "create, migrate, and seed the database"
  task :setup do
    %w(
      create
      migrate
      seed
    ).each {|t|
      Rake::Task["db:#{t}"].invoke
    }
  end

  desc "create the database"
  task :create do
  end

  desc "migrate the database"
  task :migrate do
  end

  desc "seed the database"
  task :seed do
  end
end

namespace :docs do
  desc "update to the latest doc files"
  task :update do
    system 'rm -rf docs && git clone git@github.com:pakyow/docs.git'
  end

  desc 'generate sitemap content for docs'
  task :sitemap => [:'pakyow:stage'] do
    docs = 'http://pakyow.org/docs'
    now = Time.now

    Category.all.each do |category|
      puts  "<url>\n"\
            "  <loc>#{File.join(docs, category.uri)}</loc>\n"\
            "  <changefreq>monthly</changefreq>\n"\
            "  <lastmod>#{now.year}-#{now.month}-#{now.day}T00:00:00Z</lastmod>\n"\
            "</url>\n"

      category.topics.each do |topic|
        puts  "<url>\n"\
            "  <loc>#{File.join(docs, topic.uri)}</loc>\n"\
            "  <changefreq>monthly</changefreq>\n"\
            "  <lastmod>#{now.year}-#{now.month}-#{now.day}T00:00:00Z</lastmod>\n"\
            "</url>\n"
      end
    end
  end
end
